var Cobj,LinearGradient,RadialGradient,DrawCmd,svgToCgoRHC,svgToCgoSVG,cgoRHCtoSVG,shapeDefs,Cango=function(){"use strict"
function addEvent(element,eventType,handler){return element.attachEvent?element.attachEvent("on"+eventType,handler):element.addEventListener(eventType,handler,!0)}function clone(orgItem){var i,newItem=Array.isArray(orgItem)?[]:{}
for(i in orgItem)orgItem[i]&&"object"==typeof orgItem[i]?newItem[i]=clone(orgItem[i]):newItem[i]=orgItem[i]
return newItem}function isArray(obj){return"[object Array]"===Object.prototype.toString.call(obj)}function flatten(obj){return isArray(obj)?obj.reduce(function(prev,curr){var more=[].concat(curr).some(isArray)
return prev.concat(more?flatten(curr):curr)},[]):[obj]}function Path(commands){this.type="PATH",this.drawCmds=cgo2DtoDrawCmd(commands),this.dwgOrg={x:0,y:0},this.dragNdrop=null,this.iso=!1,this.border=!1,this.strokeCol=null,this.lineWidth=1,this.lineCap=null,this.shadowOffsetX=0,this.shadowOffsetY=0,this.shadowBlur=0,this.shadowColor="#000000",this.dashed=null,this.dashOffset=0}function Shape(commands){Path.call(this,commands),this.type="SHAPE",this.iso=!0}function Img(url){this.type="IMG",this.drawCmds=url,this.imgBuf=new Image,this.bBoxCmds=[],this.dwgOrg={x:0,y:0},this.width=0,this.height=0,this.imgX=0,this.imgY=0,this.imgLorgX=0,this.imgLorgY=0,this.imgXscale=1,this.imgYscale=1,this.imgDegs=0,this.lorg=1,this.dragNdrop=null,this.border=!1,this.strokeCol=null,this.lineWidth=1,this.lineCap=null,this.shadowOffsetX=0,this.shadowOffsetY=0,this.shadowBlur=0,this.shadowColor="#000000",this.imgBuf.src=url}function Text(txtString){this.type="TEXT",this.drawCmds=txtString,this.bBoxCmds=[],this.dwgOrg={x:0,y:0},this.imgX=0,this.imgY=0,this.imgLorgX=0,this.imgLorgY=0,this.imgXscale=1,this.imgYscale=1,this.imgDegs=0,this.lorg=1,this.dragNdrop=null,this.border=!1,this.fillCol=null,this.fontSize=null,this.fontWeight=null,this.fontFamily=null,this.shadowOffsetX=0,this.shadowOffsetY=0,this.shadowBlur=0,this.shadowColor="#000000"}function Layer(canvasID,canvasElement){this.id=canvasID,this.cElem=canvasElement,this.dragObjects=[]}var svgParser,cgo2DtoDrawCmd,uniqueVal=0
return svgParser=function(){function svgCmdCheck(acc,current,idx){return 0===idx&&"string"!=typeof current&&acc.push("M"),"string"==typeof current&&(svgProtocol.hasOwnProperty(current.toUpperCase())||(console.log("unknown command string '"+current+"'"),acc.badCmdFound=!0,acc.length=0)),acc.badCmdFound||acc.push(current),acc}function unExtend(acc,current,idx,ary){var newCmd
if(0===idx&&(acc.nextCmdPos=0),"string"==typeof current){if(idx<acc.nextCmdPos)return console.log("bad number of parameters for '"+current+"' at index "+idx),acc.badParameter=!0,acc.push(0),acc
acc.currCmd=current.toUpperCase(),acc.uc=current.toUpperCase()===current,acc.nextCmdPos=idx+svgProtocol[acc.currCmd].parmCount+1,acc.push(current)}else idx<acc.nextCmdPos?acc.push(current):(acc.currCmd=svgProtocol[acc.currCmd].extCmd,newCmd=acc.uc?acc.currCmd:acc.currCmd.toLowerCase(),acc.push(newCmd,current),acc.nextCmdPos=idx+svgProtocol[acc.currCmd].parmCount)
return idx===ary.length-1&&acc.badParameter&&(acc.length=0),acc}function svgCmdSplitter(acc,curr){return"string"==typeof curr&&acc.push([]),acc[acc.length-1].push(curr),acc}function toAbsoluteCoords(acc,current,idx){var currCmd,currAbs
return void 0===acc.px&&(acc.px=0,acc.py=0),currCmd=svgProtocol[current[0].toUpperCase()],currAbs=currCmd.toAbs(acc,current,idx),acc.push(currAbs),acc}function toCangoCmdSet(acc,current,idx){var currCmd=current[0],currSvgObj=svgProtocol[currCmd]
return currSvgObj.toCangoVersion(acc,current,idx),acc}function toDrawCmds(current){var cmd=current[0],parameters=current.slice(1)
return new DrawCmd(svgProtocol[cmd].canvasMethod,parameters)}function strToCgo2D(acc,current){var parmsStr,numberStrs,cmd=current[0]
return acc.push(cmd),parmsStr=current.slice(1),numberStrs=parmsStr.match(/\S+/g),numberStrs&&numberStrs.forEach(function(s){var num=parseFloat(s)
isNaN(num)||acc.push(num)}),acc}function flipCoords(current){var currCmd=current[0],currSvgObj=svgProtocol[currCmd]
return currSvgObj.invertCoords(current)}function translateOrigin(current){var currCmd=current[0],currSvgObj=svgProtocol[currCmd],xofs=this.xOfs||0,yofs=this.yOfs||0
return currSvgObj.addXYoffset(current,xofs,yofs)}function flatten2Dary(acc,curr){return acc.concat(curr)}var segmentToBezier=function(cx,cy,th0,th1,rx,ry,sin_th,cos_th){var a00=cos_th*rx,a01=-sin_th*ry,a10=sin_th*rx,a11=cos_th*ry,th_half=.5*(th1-th0),t=8/3*Math.sin(.5*th_half)*Math.sin(.5*th_half)/Math.sin(th_half),x1=cx+Math.cos(th0)-t*Math.sin(th0),y1=cy+Math.sin(th0)+t*Math.cos(th0),x3=cx+Math.cos(th1),y3=cy+Math.sin(th1),x2=x3+t*Math.sin(th1),y2=y3-t*Math.cos(th1)
return[a00*x1+a01*y1,a10*x1+a11*y1,a00*x2+a01*y2,a10*x2+a11*y2,a00*x3+a01*y3,a10*x3+a11*y3]},arcToBezier=function(ox,oy,radx,rady,rotateX,large,sweep,x,y){function roundZeros(coord){return Math.abs(coord)<1e-5?0:coord}var a00,a01,a10,a11,x0,y0,x1,y1,d,sfactor_sq,sfactor,xc,yc,th0,th1,th_arc,segments,seg,tidySeg,i,th2,th3,th=rotateX*(Math.PI/180),sin_th=Math.sin(th),cos_th=Math.cos(th),rx=Math.abs(radx),ry=Math.abs(rady),px=cos_th*(ox-x)*.5+sin_th*(oy-y)*.5,py=cos_th*(oy-y)*.5-sin_th*(ox-x)*.5,pl=px*px/(rx*rx)+py*py/(ry*ry),result=[]
for(pl>1&&(pl=Math.sqrt(pl),rx*=pl,ry*=pl),a00=cos_th/rx,a01=sin_th/rx,a10=-sin_th/ry,a11=cos_th/ry,x0=a00*ox+a01*oy,y0=a10*ox+a11*oy,x1=a00*x+a01*y,y1=a10*x+a11*y,d=(x1-x0)*(x1-x0)+(y1-y0)*(y1-y0),sfactor_sq=1/d-.25,0>sfactor_sq&&(sfactor_sq=0),sfactor=Math.sqrt(sfactor_sq),sweep===large&&(sfactor=-sfactor),xc=.5*(x0+x1)-sfactor*(y1-y0),yc=.5*(y0+y1)+sfactor*(x1-x0),th0=Math.atan2(y0-yc,x0-xc),th1=Math.atan2(y1-yc,x1-xc),th_arc=th1-th0,0>th_arc&&1===sweep?th_arc+=2*Math.PI:th_arc>0&&0===sweep&&(th_arc-=2*Math.PI),segments=Math.ceil(Math.abs(th_arc/(.5*Math.PI+.001))),i=0;segments>i;i++)th2=th0+i*th_arc/segments,th3=th0+(i+1)*th_arc/segments,seg=segmentToBezier(xc,yc,th2,th3,rx,ry,sin_th,cos_th),tidySeg=seg.map(roundZeros),result.push(tidySeg)
return result},svgProtocol={M:{canvasMethod:"moveTo",parmCount:2,extCmd:"L",toAbs:function(acc,curr){var currAbs,cmd=curr[0].toUpperCase(),x=curr[1],y=curr[2]
return cmd!==curr[0]&&(x+=acc.px,y+=acc.py),currAbs=[cmd,x,y],acc.px=x,acc.py=y,currAbs},toCangoVersion:function(acc,curr){var x=curr[1],y=curr[2]
acc.px=x,acc.py=y,acc.push(curr)},addXYoffset:function(curr,xOfs,yOfs){var x=curr[1],y=curr[2]
return x+=xOfs,y+=yOfs,["M",x,y]},invertCoords:function(curr){var x=curr[1],y=curr[2]
return["M",x,-y]}},L:{canvasMethod:"lineTo",parmCount:2,extCmd:"L",toAbs:function(acc,curr){var currAbs,cmd=curr[0].toUpperCase(),x=curr[1],y=curr[2]
return cmd!==curr[0]&&(x+=acc.px,y+=acc.py),currAbs=[cmd,x,y],acc.px=x,acc.py=y,currAbs},toCangoVersion:function(acc,curr){var x=curr[1],y=curr[2]
acc.px=x,acc.py=y,acc.push(curr)},addXYoffset:function(curr,xOfs,yOfs){var x=curr[1],y=curr[2]
return x+=xOfs,y+=yOfs,["L",x,y]},invertCoords:function(curr){var x=curr[1],y=curr[2]
return["L",x,-y]}},H:{parmCount:1,extCmd:"H",toAbs:function(acc,curr){var currAbs,cmd=curr[0].toUpperCase(),x=curr[1]
return cmd!==curr[0]&&(x+=acc.px),currAbs=[cmd,x],acc.px=x,currAbs},toCangoVersion:function(acc,curr){var x=curr[1],y=acc.py,cangoVer=["L",x,y]
acc.px=x,acc.push(cangoVer)},addXYoffset:function(curr,xOfs){var x=curr[1]
return x+=xOfs,["H",x]},invertCoords:function(curr){var x=curr[1]
return["H",x]}},V:{parmCount:1,extCmd:"V",toAbs:function(acc,curr){var currAbs,cmd=curr[0].toUpperCase(),y=curr[1]
return cmd!==curr[0]&&(y+=acc.py),currAbs=[cmd,y],acc.py=y,currAbs},toCangoVersion:function(acc,curr){var x=acc.px,y=curr[1],cangoVer=["L",x,y]
acc.py=y,acc.push(cangoVer)},addXYoffset:function(curr,xOfs,yOfs){var y=curr[1]
return y+=yOfs,["V",y]},invertCoords:function(curr){var y=curr[1]
return["V",-y]}},C:{canvasMethod:"bezierCurveTo",parmCount:6,extCmd:"C",toAbs:function(acc,curr){var currAbs,cmd=curr[0].toUpperCase(),c1x=curr[1],c1y=curr[2],c2x=curr[3],c2y=curr[4],x=curr[5],y=curr[6]
return cmd!==curr[0]&&(c1x+=acc.px,c1y+=acc.py,c2x+=acc.px,c2y+=acc.py,x+=acc.px,y+=acc.py),currAbs=[cmd,c1x,c1y,c2x,c2y,x,y],acc.px=x,acc.py=y,currAbs},toCangoVersion:function(acc,curr){var x=curr[5],y=curr[6]
acc.px=x,acc.py=y,acc.push(curr)},addXYoffset:function(curr,xOfs,yOfs){var c1x=curr[1],c1y=curr[2],c2x=curr[3],c2y=curr[4],x=curr[5],y=curr[6]
return c1x+=xOfs,c1y+=yOfs,c2x+=xOfs,c2y+=yOfs,x+=xOfs,y+=yOfs,["C",c1x,c1y,c2x,c2y,x,y]},invertCoords:function(curr){var c1x=curr[1],c1y=curr[2],c2x=curr[3],c2y=curr[4],x=curr[5],y=curr[6]
return["C",c1x,-c1y,c2x,-c2y,x,-y]}},S:{parmCount:4,extCmd:"S",toAbs:function(acc,curr){var currAbs,cmd=curr[0].toUpperCase(),c2x=curr[1],c2y=curr[2],x=curr[3],y=curr[4]
return cmd!==curr[0]&&(c2x+=acc.px,c2y+=acc.py,x+=acc.px,y+=acc.py),currAbs=[cmd,c2x,c2y,x,y],acc.px=x,acc.py=y,currAbs},toCangoVersion:function(acc,curr,idx){var cangoVer,c1x=0,c1y=0,c2x=curr[1],c2y=curr[2],x=curr[3],y=curr[4],prevSeg=acc[idx-1]
"C"===prevSeg[0]&&(c1x=acc.px-prevSeg[prevSeg.length-4],c1y=acc.py-prevSeg[prevSeg.length-3]),c1x+=acc.px,c1y+=acc.py,cangoVer=["C",c1x,c1y,c2x,c2y,x,y],acc.px=x,acc.py=y,acc.push(cangoVer)},addXYoffset:function(curr,xOfs,yOfs){var c2x=curr[1],c2y=curr[2],x=curr[3],y=curr[4]
return c2x+=xOfs,c2y+=yOfs,x+=xOfs,y+=yOfs,["S",c2x,c2y,x,y]},invertCoords:function(curr){var c2x=curr[1],c2y=curr[2],x=curr[3],y=curr[4]
return["S",c2x,-c2y,x,-y]}},Q:{canvasMethod:"quadraticCurveTo",parmCount:4,extCmd:"Q",toAbs:function(acc,curr){var currAbs,cmd=curr[0].toUpperCase(),c1x=curr[1],c1y=curr[2],x=curr[3],y=curr[4]
return cmd!==curr[0]&&(c1x+=acc.px,c1y+=acc.py,x+=acc.px,y+=acc.py),currAbs=[cmd,c1x,c1y,x,y],acc.px=x,acc.py=y,currAbs},toCangoVersion:function(acc,curr){var x=curr[3],y=curr[4]
acc.px=x,acc.py=y,acc.push(curr)},addXYoffset:function(curr,xOfs,yOfs){var c1x=curr[1],c1y=curr[2],x=curr[3],y=curr[4]
return c1x+=xOfs,c1y+=yOfs,x+=xOfs,y+=yOfs,["Q",c1x,c1y,x,y]},invertCoords:function(curr){var c1x=curr[1],c1y=curr[2],x=curr[3],y=curr[4]
return["Q",c1x,-c1y,x,-y]}},T:{parmCount:2,extCmd:"T",toAbs:function(acc,curr){var currAbs,cmd=curr[0].toUpperCase(),x=curr[1],y=curr[2]
return cmd!==curr[0]&&(x+=acc.px,y+=acc.py),currAbs=[cmd,x,y],acc.px=x,acc.py=y,currAbs},toCangoVersion:function(acc,curr,idx){var cangoVer,c1x=0,c1y=0,x=curr[1],y=curr[2],prevSeg=acc[idx-1]
"Q"===prevSeg[0]&&(c1x=acc.px-prevSeg[prevSeg.length-4],c1y=acc.py-prevSeg[prevSeg.length-3]),c1x+=acc.px,c1y+=acc.py,cangoVer=["Q",c1x,c1y,x,y],acc.px=x,acc.py=y,acc.push(cangoVer)},addXYoffset:function(curr,xOfs,yOfs){var x=curr[1],y=curr[2]
return x+=xOfs,y+=yOfs,["T",x,y]},invertCoords:function(curr){var x=curr[1],y=curr[2]
return["T",x,-y]}},A:{parmCount:7,extCmd:"A",toAbs:function(acc,curr){var currAbs,cmd=curr[0].toUpperCase(),rx=curr[1],ry=curr[2],xrot=curr[3],lrg=curr[4],swp=curr[5],x=curr[6],y=curr[7]
return cmd!==curr[0]&&(x+=acc.px,y+=acc.py),currAbs=[cmd,rx,ry,xrot,lrg,swp,x,y],acc.px=x,acc.py=y,currAbs},toCangoVersion:function(acc,curr){var sectors,rx=curr[1],ry=curr[2],xrot=curr[3],lrg=curr[4],swp=curr[5],x=curr[6],y=curr[7]
sectors=arcToBezier(acc.px,acc.py,rx,ry,xrot,lrg,swp,x,y),sectors.forEach(function(coordAry){acc.push(["C"].concat(coordAry))}),acc.px=x,acc.py=y},addXYoffset:function(curr,xOfs,yOfs){var rx=curr[1],ry=curr[2],xrot=curr[3],lrg=curr[4],swp=curr[5],x=curr[6],y=curr[7]
return x+=xOfs,y+=yOfs,["A",rx,ry,xrot,lrg,swp,x,y]},invertCoords:function(curr){var rx=curr[1],ry=curr[2],xrot=curr[3],lrg=curr[4],swp=curr[5],x=curr[6],y=curr[7]
return["A",rx,ry,-xrot,lrg,1-swp,x,-y]}},Z:{canvasMethod:"closePath",parmCount:0,toAbs:function(acc,curr){var cmd=curr[0].toUpperCase(),currAbs=[cmd]
return currAbs},toCangoVersion:function(acc,curr){acc.push(curr)},addXYoffset:function(){return["Z"]},invertCoords:function(){return["Z"]}}}
return{svg2cartesian:function(svgStr,xShft,yShft){var noCommas,cmdStrs,dx=xShft||0,dy=yShft||0
return"string"!=typeof svgStr||0===svgStr.length?[]:(noCommas=svgStr.replace(RegExp(",","g")," "),cmdStrs=noCommas.split(/(?=[a-df-z])/i),cmdStrs.reduce(strToCgo2D,[]).reduce(svgCmdCheck,[]).reduce(unExtend,[]).reduce(svgCmdSplitter,[]).reduce(toAbsoluteCoords,[]).map(translateOrigin,{xOfs:dx,yOfs:dy}).map(flipCoords).reduce(flatten2Dary,[]))},svg2cgosvg:function(svgStr,xShft,yShft){var noCommas,cmdStrs,dx=xShft||0,dy=yShft||0
return"string"!=typeof svgStr||0===svgStr.length?[]:(noCommas=svgStr.replace(RegExp(",","g")," "),cmdStrs=noCommas.split(/(?=[a-df-z])/i),cmdStrs.reduce(strToCgo2D,[]).reduce(svgCmdCheck,[]).reduce(unExtend,[]).reduce(svgCmdSplitter,[]).reduce(toAbsoluteCoords,[]).map(translateOrigin,{xOfs:dx,yOfs:dy}).reduce(flatten2Dary,[]))},cartesian2svg:function(cgoAry){return""+cgoAry.reduce(unExtend,[]).reduce(svgCmdSplitter,[]).reduce(toAbsoluteCoords,[]).map(flipCoords).reduce(flatten2Dary,[])},cgo2drawcmds:function(cgo2Dary){return isArray(cgo2Dary)&&0!==cgo2Dary.length?cgo2Dary.reduce(svgCmdCheck,[]).reduce(unExtend,[]).reduce(svgCmdSplitter,[]).reduce(toAbsoluteCoords,[]).reduce(toCangoCmdSet,[]).map(toDrawCmds):[]}}}(),svgToCgoRHC=svgParser.svg2cartesian,svgToCgoSVG=svgParser.svg2cgosvg,cgoRHCtoSVG=svgParser.cartesian2svg,cgo2DtoDrawCmd=svgParser.cgo2drawcmds,void 0===shapeDefs&&(shapeDefs={circle:function(diameter){var d=diameter||1
return["m",-.5*d,0,"c",0,-.27614*d,.22386*d,-.5*d,.5*d,-.5*d,"c",.27614*d,0,.5*d,.22386*d,.5*d,.5*d,"c",0,.27614*d,-.22386*d,.5*d,-.5*d,.5*d,"c",-.27614*d,0,-.5*d,-.22386*d,-.5*d,-.5*d]},ellipse:function(width,height){var w=width||1,h=w
return"number"==typeof height&&height>0&&(h=height),["m",-.5*w,0,"c",0,-.27614*h,.22386*w,-.5*h,.5*w,-.5*h,"c",.27614*w,0,.5*w,.22386*h,.5*w,.5*h,"c",0,.27614*h,-.22386*w,.5*h,-.5*w,.5*h,"c",-.27614*w,0,-.5*w,-.22386*h,-.5*w,-.5*h]},square:function(width){var w=width||1
return["m",.5*w,-.5*w,"l",0,w,-w,0,0,-w,"z"]},rectangle:function(w,h,rad){var r,m=.55228475
return void 0===rad||0>=rad?["m",-w/2,-h/2,"l",w,0,0,h,-w,0,"z"]:(r=Math.min(w/2,h/2,rad),["m",-w/2+r,-h/2,"l",w-2*r,0,"c",m*r,0,r,(1-m)*r,r,r,"l",0,h-2*r,"c",0,m*r,(m-1)*r,r,-r,r,"l",-w+2*r,0,"c",-m*r,0,-r,(m-1)*r,-r,-r,"l",0,-h+2*r,"c",0,-m*r,(1-m)*r,-r,r,-r])},triangle:function(side){var s=side||1
return["m",.5*s,-.289*s,"l",-.5*s,.866*s,-.5*s,-.866*s,"z"]},cross:function(width){var w=width||1
return["m",-.5*w,0,"l",w,0,"m",-.5*w,-.5*w,"l",0,w]},ex:function(diagonal){var d=diagonal||1
return["m",-.3535*d,-.3535*d,"l",.707*d,.707*d,"m",-.707*d,0,"l",.707*d,-.707*d]}}),LinearGradient=function(p1x,p1y,p2x,p2y){this.grad=[p1x,p1y,p2x,p2y],this.colorStops=[],this.addColorStop=function(){this.colorStops.push(arguments)}},RadialGradient=function(p1x,p1y,r1,p2x,p2y,r2){this.grad=[p1x,p1y,r1,p2x,p2y,r2],this.colorStops=[],this.addColorStop=function(){this.colorStops.push(arguments)}},DrawCmd=function(cmdStr,coords){var i
for(this.drawFn=cmdStr,this.parms=[],i=0;i<coords.length;i+=2)this.parms.push(coords.slice(i,i+2))
this.parmsPx=[]},Path.prototype.translate=function(x,y){this.drawCmds.forEach(function(cmd){cmd.parms=cmd.parms.map(function(p){return[p[0]+x,p[1]+y]})})},Path.prototype.rotate=function(degs){var A=Math.PI*degs/180,sinA=Math.sin(A),cosA=Math.cos(A)
this.drawCmds.forEach(function(cmd){cmd.parms=cmd.parms.map(function(p){return[p[0]*cosA-p[1]*sinA,p[0]*sinA+p[1]*cosA]})})},Path.prototype.scale=function(xScl,yScl,lineWdScl){var xScale=xScl||1,yScale=yScl||xScale,lwScale=lineWdScl||1
this.drawCmds.forEach(function(cmd){cmd.parms=cmd.parms.map(function(p){return[p[0]*xScale,p[1]*yScale]})}),lwScale>0&&(this.lineWidth*=lwScale)},Path.prototype.appendPath=function(obj,delMove){var dcs=clone(obj.drawCmds)
delMove?this.drawCmds=this.drawCmds.concat(dcs.slice(1)):this.drawCmds=this.drawCmds.concat(dcs)},Path.prototype.revWinding=function(){function revPairs(ary){return ary.reduceRight(function(acc,curr){return acc.push(curr[0],curr[1]),acc},[])}var cmds,k,len,dParms,dCmd,zCmd=null,revCmds=[]
for("closePath"===this.drawCmds[this.drawCmds.length-1].drawFn?(cmds=this.drawCmds.slice(0,-1),zCmd=this.drawCmds.slice(-1)):cmds=this.drawCmds.slice(0),k=cmds.length-1,len=cmds[k].parms.length,dCmd=new DrawCmd("moveTo",cmds[k].parms[len-1]),revCmds.push(dCmd),cmds[k].parms=cmds[k].parms.slice(0,-1);k>0;)dParms=revPairs(cmds[k].parms),len=cmds[k-1].parms.length,dParms=dParms.concat(cmds[k-1].parms[len-1]),dCmd=new DrawCmd(cmds[k].drawFn,dParms),revCmds.push(dCmd),cmds[k-1].parms=cmds[k-1].parms.slice(0,-1),k--
zCmd&&revCmds.push(zCmd),this.drawCmds=revCmds},Shape.prototype=new Path,Img.prototype.translate=function(x,y){this.imgX+=x,this.imgY+=y},Img.prototype.rotate=function(degs){this.imgDegs+=degs},Img.prototype.scale=function(xScl,yScl){var xScale=xScl||1,yScale=yScl||xScale
this.imgXscale*=xScale,this.imgYscale*=yScale,this.imgX*=xScale,this.imgY*=yScale},Img.prototype.formatImg=function(){var wid,hgt,wid2,hgt2,ulx,uly,llx,lly,lrx,lry,urx,ury,lorgWC,dx=0,dy=0
this.imgBuf.width||console.log("in image onload handler yet image NOT loaded!"),this.width&&this.height?(wid=this.width,hgt=this.height):this.width&&!this.height?(wid=this.width,hgt=this.height||wid*this.imgBuf.height/this.imgBuf.width):this.height&&!this.width?(hgt=this.height,wid=this.width||hgt*this.imgBuf.width/this.imgBuf.height):(wid=this.imgBuf.width,hgt=this.imgBuf.height),wid2=wid/2,hgt2=hgt/2,lorgWC=[0,[0,0],[wid2,0],[wid,0],[0,hgt2],[wid2,hgt2],[wid,hgt2],[0,hgt],[wid2,hgt],[wid,hgt]],void 0!==lorgWC[this.lorg]&&(dx=-lorgWC[this.lorg][0],dy=-lorgWC[this.lorg][1]),this.imgLorgX=dx,this.imgLorgY=dy,this.width=wid,this.height=hgt,ulx=this.imgX+dx,uly=this.imgY+dy,llx=this.imgX+dx,lly=this.imgY+dy+hgt,lrx=this.imgX+dx+wid,lry=this.imgY+dy+hgt,urx=this.imgX+dx+wid,ury=this.imgY+dy,this.bBoxCmds[0]=new DrawCmd("moveTo",[ulx,-uly]),this.bBoxCmds[1]=new DrawCmd("lineTo",[llx,-lly]),this.bBoxCmds[2]=new DrawCmd("lineTo",[lrx,-lry]),this.bBoxCmds[3]=new DrawCmd("lineTo",[urx,-ury]),this.bBoxCmds[4]=new DrawCmd("closePath",[])},Text.prototype.translate=function(x,y){this.imgX+=x,this.imgY+=y},Text.prototype.rotate=function(degs){this.imgDegs+=degs},Text.prototype.scale=function(xScl,yScl){var xScale=xScl||1,yScale=yScl||xScale
this.imgXscale*=xScale,this.imgYscale*=yScale,this.imgX*=xScale,this.imgY*=yScale},Text.prototype.formatText=function(gc){var wid,hgt,wid2,hgt2,lorgWC,ulx,uly,llx,lly,lrx,lry,urx,ury,size=this.fontSize||gc.fontSize,fntFm=this.fontFamily||gc.fontFamily,lorg=this.lorg||1,dx=0,dy=0
gc.ctx.save(),gc.ctx.font=size+"px "+fntFm,wid=gc.ctx.measureText(this.drawCmds).width,gc.ctx.restore(),hgt=size,wid/=gc.xscl,hgt/=gc.xscl,wid2=wid/2,hgt2=hgt/2,lorgWC=[0,[0,hgt],[wid2,hgt],[wid,hgt],[0,hgt2],[wid2,hgt2],[wid,hgt2],[0,0],[wid2,0],[wid,0]],void 0!==lorgWC[lorg]&&(dx=-lorgWC[lorg][0],dy=lorgWC[lorg][1]),this.imgLorgX=dx,this.imgLorgY=dy-.25*hgt,this.width=wid,this.height=hgt,ulx=this.imgX+dx,uly=this.imgY+dy,llx=this.imgX+dx,lly=this.imgY+dy-hgt,lrx=this.imgX+dx+wid,lry=this.imgY+dy-hgt,urx=this.imgX+dx+wid,ury=this.imgY+dy,this.bBoxCmds[0]=new DrawCmd("moveTo",[ulx,-uly]),this.bBoxCmds[1]=new DrawCmd("lineTo",[llx,-lly]),this.bBoxCmds[2]=new DrawCmd("lineTo",[lrx,-lry]),this.bBoxCmds[3]=new DrawCmd("lineTo",[urx,-ury]),this.bBoxCmds[4]=new DrawCmd("closePath",[])},Cobj=function(data,objtype,options){var objClass,opt,prop,classObj=Path
switch(objtype){case"PATH":classObj=Path
break
case"SHAPE":classObj=Shape
break
case"IMG":classObj=Img
break
case"TEXT":classObj=Text}classObj.call(this,data),objClass=new classObj
for(prop in objClass)"function"==typeof objClass[prop]&&(this[prop]=objClass[prop])
opt="object"==typeof options?options:{}
for(prop in opt)opt.hasOwnProperty(prop)&&this.setProperty(prop,opt[prop])},Cobj.prototype.setProperty=function(propertyName,value){if("string"==typeof propertyName&&void 0!==value)switch(propertyName.toLowerCase()){case"fillcolor":this.fillCol=value
break
case"strokecolor":this.strokeCol=value
break
case"linewidth":case"strokewidth":this.lineWidth=Math.abs(value)
break
case"linecap":if("string"!=typeof value)return;("butt"===value||"round"===value||"square"===value)&&(this.lineCap=value)
break
case"iso":case"isotropic":1==value||"iso"===value||"isotropic"===value?this.iso=!0:this.iso=!1
break
case"dashed":isArray(value)&&value[0]?this.dashed=value:this.dashed=null
break
case"dashoffset":this.dashOffset=value||0
break
case"border":1==value&&(this.border=!0),0==value&&(this.border=!1)
break
case"fontsize":this.fontSize=Math.abs(value)
break
case"fontweight":("string"==typeof value||"number"==typeof value&&value>=100&&900>=value)&&(this.fontWeight=value)
break
case"fontfamily":"string"==typeof value&&(this.fontFamily=value)
break
case"imgwidth":this.width=Math.abs(value)
break
case"imgheight":this.height=Math.abs(value)
break
case"lorg":[1,2,3,4,5,6,7,8,9].indexOf(value)>-1&&(this.lorg=value)
break
case"shadowoffsetx":this.shadowOffsetX=value||0
break
case"shadowoffsety":this.shadowOffsetY=value||0
break
case"shadowblur":this.shadowBlur=value||0
break
case"shadowcolor":this.shadowColor=value
break
default:return}},Cobj.prototype.dup=function(){var newObj=new Cobj
return newObj.type=this.type,newObj.drawCmds=clone(this.drawCmds),newObj.imgBuf=this.imgBuf,newObj.bBoxCmds=clone(this.bBoxCmds),newObj.dwgOrg=clone(this.dwgOrg),newObj.iso=this.iso,newObj.border=this.border,newObj.strokeCol=this.strokeCol,newObj.fillCol=this.fillCol,newObj.lineWidth=this.lineWidth,newObj.lineCap=this.lineCap,newObj.width=this.width,newObj.height=this.height,newObj.imgX=this.imgX,newObj.imgY=this.imgY,newObj.imgLorgX=this.imgLorgX,newObj.imgLorgY=this.imgLorgY,newObj.imgXscale=this.imgXscale,newObj.imgYscale=this.imgYscale,newObj.imgDegs=this.imgDegs,newObj.lorg=this.lorg,newObj.dragNdrop=null,newObj.fontSize=this.fontSize,newObj.fontWeight=this.fontWeight,newObj.fontFamily=this.fontFamily,newObj.shadowOffsetX=this.shadowOffsetX,newObj.shadowOffsetY=this.shadowOffsetY,newObj.shadowBlur=this.shadowBlur,newObj.shadowColor=this.shadowColor,newObj.dashed=this.dashed,newObj.dashOffset=this.dashOffset,newObj},Cango=function(canvasId){function resizeLayers(){var j,ovl,t=savThis.bkgCanvas.offsetTop+savThis.bkgCanvas.clientTop,l=savThis.bkgCanvas.offsetLeft+savThis.bkgCanvas.clientLeft,w=savThis.bkgCanvas.offsetWidth,h=savThis.bkgCanvas.offsetHeight
if(savThis.rawWidth=w,savThis.rawHeight=h,savThis.aRatio=w/h,savThis.bkgCanvas===savThis.cnvs)for(savThis.cnvs.setAttribute("width",w),savThis.cnvs.setAttribute("height",h),savThis.buffered&&(savThis.cnvs.buf.setAttribute("width",w),savThis.cnvs.buf.setAttribute("height",h)),j=1;j<savThis.bkgCanvas.layers.length;j++)ovl=savThis.bkgCanvas.layers[j].cElem,ovl&&(ovl.style.top=t+"px",ovl.style.left=l+"px",ovl.style.width=w+"px",ovl.style.height=h+"px",ovl.setAttribute("width",w),ovl.setAttribute("height",h),ovl.buf&&(ovl.buf.setAttribute("width",w),ovl.buf.setAttribute("height",h)))}var bkgId,bkgL,savThis=this
return this.cId=canvasId,this.cnvs=document.getElementById(canvasId),null===this.cnvs?void alert("can't find canvas "+canvasId):(this.bkgCanvas=this.cnvs,-1!==canvasId.indexOf("_ovl_")&&(bkgId=canvasId.slice(0,canvasId.indexOf("_ovl_")),this.bkgCanvas=document.getElementById(bkgId)),this.rawWidth=this.cnvs.offsetWidth,this.rawHeight=this.cnvs.offsetHeight,this.aRatio=this.rawWidth/this.rawHeight,this.widthPW=100,this.heightPW=this.widthPW/this.aRatio,this.bkgCanvas.hasOwnProperty("layers")||(this.bkgCanvas.layers=[],bkgL=new Layer(this.cId,this.cnvs),this.bkgCanvas.layers[0]=bkgL),"undefined"==typeof Timeline||this.bkgCanvas.hasOwnProperty("timeline")||(this.bkgCanvas.timeline=new Timeline),this.cnvs.hasOwnProperty("resized")||(this.cnvs.setAttribute("width",this.rawWidth),this.cnvs.setAttribute("height",this.rawHeight),this.cnvs.resized=!0),this.buffered&&(this.cnvs.buf=document.createElement("canvas"),this.cnvs.buf.setAttribute("width",this.rawWidth),this.cnvs.buf.setAttribute("height",this.rawHeight),this.bufCtx=this.cnvs.buf.getContext("2d")),this.ctx=this.cnvs.getContext("2d"),this.yDown=!1,this.vpW=this.rawWidth,this.vpH=this.rawHeight,this.vpOrgX=0,this.vpOrgY=this.rawHeight,this.xscl=1,this.yscl=-1,this.xoffset=0,this.yoffset=0,this.savWC={xscl:this.xscl,yscl:this.yscl,xoffset:this.xoffset,yoffset:this.yoffset},this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic",this.penCol="rgba(0, 0, 0, 1.0)",this.penWid=1,this.lineCap="butt",this.paintCol="rgba(128,128,128,1.0)",this.fontSize=12,this.fontWeight=400,this.fontFamily="Consolas, Monaco, 'Andale Mono', monospace",this.getUnique=function(){return uniqueVal+=1},this.initModules(),void addEvent(window,"resize",resizeLayers))},Cango.prototype.initModules=function(){},Cango.prototype.getHostLayer=function(){var i,lyr=this.bkgCanvas.layers[0]
for(i=1;i<this.bkgCanvas.layers.length;i++)if(this.bkgCanvas.layers[i].id===this.cId){lyr=this.bkgCanvas.layers[i]
break}return lyr},Cango.prototype.toPixelCoords=function(x,y){var xPx=this.vpOrgX+this.xoffset+x*this.xscl,yPx=this.vpOrgY+this.yoffset+y*this.yscl
return{x:xPx,y:yPx}},Cango.prototype.toWorldCoords=function(xPx,yPx){var xW=(xPx-this.vpOrgX-this.xoffset)/this.xscl,yW=(yPx-this.vpOrgY-this.yoffset)/this.yscl
return{x:xW,y:yW}},Cango.prototype.getCursorPosWC=function(evt){var e=evt||window.event,rect=this.cnvs.getBoundingClientRect(),xW=(e.clientX-rect.left-this.vpOrgX-this.xoffset)/this.xscl,yW=(e.clientY-rect.top-this.vpOrgY-this.yoffset)/this.yscl
return{x:xW,y:yW}},Cango.prototype.clearCanvas=function(fillColor){function genLinGrad(lgrad){var p1=savThis.toPixelCoords(lgrad.grad[0],lgrad.grad[1]),p2=savThis.toPixelCoords(lgrad.grad[2],lgrad.grad[3]),grad=savThis.ctx.createLinearGradient(p1.x,p1.y,p2.x,p2.y)
return lgrad.colorStops.forEach(function(colStop){grad.addColorStop(colStop[0],colStop[1])}),grad}function genRadGrad(rgrad){var p1=savThis.toPixelCoords(rgrad.grad[0],rgrad.grad[1]),r1=rgrad.grad[2]*savThis.xscl,p2=savThis.toPixelCoords(rgrad.grad[3],rgrad.grad[4]),r2=rgrad.grad[5]*savThis.xscl,grad=savThis.ctx.createRadialGradient(p1.x,p1.y,r1,p2.x,p2.y,r2)
return rgrad.colorStops.forEach(function(colStop){grad.addColorStop(colStop[0],colStop[1])}),grad}var layerObj,savThis=this
fillColor?(this.ctx.save(),fillColor instanceof LinearGradient?this.ctx.fillStyle=genLinGrad(fillColor):fillColor instanceof RadialGradient?this.ctx.fillStyle=genRadGrad(fillColor):this.ctx.fillStyle=fillColor,this.ctx.fillRect(0,0,this.rawWidth,this.rawHeight),this.ctx.restore()):this.ctx.clearRect(0,0,this.rawWidth,this.rawHeight),layerObj=this.getHostLayer(),layerObj.dragObjects.length=0,this.cnvs.alphaOvl&&this.cnvs.alphaOvl.parentNode&&this.cnvs.alphaOvl.parentNode.removeChild(this.cnvs.alphaOvl)},Cango.prototype.setGridboxRHC=function(lowerLeftX,lowerLeftY,w,h){h&&w&&h>0&&w>0?(this.vpW=w*this.rawWidth/100,this.vpH=h*this.rawWidth/100,this.vpOrgX=lowerLeftX*this.rawWidth/100,this.vpOrgY=this.rawHeight-lowerLeftY*this.rawWidth/100):(this.vpW=this.rawWidth,this.vpH=this.rawHeight,this.vpOrgX=0,this.vpOrgY=this.rawHeight),this.yDown=!1,this.setWorldCoords()},Cango.prototype.setGridboxSVG=function(upperLeftX,upperLeftY,w,h){h&&w&&h>0&&w>0?(this.vpW=w*this.rawWidth/100,this.vpH=h*this.rawWidth/100,this.vpOrgX=upperLeftX*this.rawWidth/100,this.vpOrgY=(this.heightPW-upperLeftY)*this.rawWidth/100):(this.vpW=this.rawWidth,this.vpH=this.rawHeight,this.vpOrgX=0,this.vpOrgY=0),this.yDown=!0,this.setWorldCoords()},Cango.prototype.fillGridbox=function(fillColor){function genLinGrad(lgrad){var p1=savThis.toPixelCoords(lgrad.grad[0],lgrad.grad[1]),p2=savThis.toPixelCoords(lgrad.grad[2],lgrad.grad[3]),grad=savThis.ctx.createLinearGradient(p1.x,p1.y,p2.x,p2.y)
return lgrad.colorStops.forEach(function(colStop){grad.addColorStop(colStop[0],colStop[1])}),grad}function genRadGrad(rgrad){var p1=savThis.toPixelCoords(rgrad.grad[0],rgrad.grad[1]),r1=rgrad.grad[2]*savThis.xscl,p2=savThis.toPixelCoords(rgrad.grad[3],rgrad.grad[4]),r2=rgrad.grad[5]*savThis.xscl,grad=savThis.ctx.createRadialGradient(p1.x,p1.y,r1,p2.x,p2.y,r2)
return rgrad.colorStops.forEach(function(colStop){grad.addColorStop(colStop[0],colStop[1])}),grad}var savThis=this,newCol=fillColor||this.paintCol,yCoord=this.yscl>0?this.vpOrgY:this.vpOrgY-this.vpH
this.ctx.save(),newCol instanceof LinearGradient?this.ctx.fillStyle=genLinGrad(newCol):newCol instanceof RadialGradient?this.ctx.fillStyle=genRadGrad(newCol):this.ctx.fillStyle=newCol,this.ctx.fillRect(this.vpOrgX,yCoord,this.vpW,this.vpH),this.ctx.restore()},Cango.prototype.setWorldCoords=function(vpOriginX,vpOriginY,spanX,spanY){var vpOrgXWC=vpOriginX||0,vpOrgYWC=vpOriginY||0
spanX&&spanX>0?this.xscl=this.vpW/spanX:this.xscl=1,spanY&&spanY>0?this.yscl=this.yDown?this.vpH/spanY:-this.vpH/spanY:this.yscl=this.yDown?this.xscl:-this.xscl,this.xoffset=-vpOrgXWC*this.xscl,this.yoffset=-vpOrgYWC*this.yscl,this.savWC={xscl:this.xscl,yscl:this.yscl,xoffset:this.xoffset,yoffset:this.yoffset}},Cango.prototype.setPropertyDefault=function(propertyName,value){if("string"==typeof propertyName&&void 0!==value&&null!==value)switch(propertyName.toLowerCase()){case"fillcolor":("string"==typeof value||"object"==typeof value)&&(this.paintCol=value)
break
case"strokecolor":("string"==typeof value||"object"==typeof value)&&(this.penCol=value)
break
case"linewidth":case"strokewidth":this.penWid=value
break
case"linecap":"string"!=typeof value||"butt"!==value&&"round"!==value&&"square"!==value||(this.lineCap=value)
break
case"fontfamily":"string"==typeof value&&(this.fontFamily=value)
break
case"fontsize":this.fontSize=value
break
case"fontweight":("string"==typeof value||value>=100&&900>=value)&&(this.fontWeight=value)
break
case"steptime":value>=15&&500>=value&&(this.stepTime=value)
break
default:return}},Cango.prototype.dropShadow=function(obj,scl){var xOfs=obj.shadowOffsetX||0,yOfs=obj.shadowOffsetY||0,radius=obj.shadowBlur||0,color=obj.shadowColor||"#000000",xScale=scl||1,yScale=scl||1
void 0!==this.ctx.shadowOffsetX&&("SHAPE"===obj.type||"PATH"===obj.type&&!obj.iso?(xScale*=this.xscl,yScale*=this.yscl):(xScale*=this.xscl,yScale*=-this.xscl),this.ctx.shadowOffsetX=xOfs*xScale,this.ctx.shadowOffsetY=yOfs*yScale,this.ctx.shadowBlur=radius*xScale,this.ctx.shadowColor=color)},Cango.prototype.render=function(pathObj,x,y,scl,degs){function processCobj(cobj){function imgLoaded(){cobj.formatImg(),savThis.paintImg(cobj,x,y,scl,degs)}"IMG"===cobj.type?cobj.imgBuf.complete?imgLoaded():addEvent(cobj.imgBuf,"load",imgLoaded):"TEXT"===cobj.type?(cobj.formatText(savThis),savThis.paintText(cobj,x,y,scl,degs)):savThis.paintPath(cobj,x,y,scl,degs)}var savThis=this
isArray(pathObj)?flatten(pathObj).forEach(processCobj):pathObj&&processCobj(pathObj)},Cango.prototype.paintImg=function(pathObj,x,y,scl,degrees){function rotXY(p){return[p[0]*cosA-p[1]*sinA,p[0]*sinA+p[1]*cosA]}var A,sinA,cosA,currLr,aidx,savThis=this,img=pathObj.imgBuf,xPos=x||0,yPos=y||0,xScale=scl||1,scale=xScale*pathObj.imgXscale,degs=degrees||0
this.ctx.save(),this.dropShadow(pathObj,xScale),this.ctx.translate(this.vpOrgX+this.xoffset+xPos*this.xscl,this.vpOrgY+this.yoffset+yPos*this.yscl),degs+=pathObj.imgDegs,degs&&(A=this.yscl>0?-degs*Math.PI/180:degs*Math.PI/180,sinA=Math.sin(A),cosA=Math.cos(A),this.ctx.rotate(-A)),this.ctx.drawImage(img,this.xscl*scale*(pathObj.imgX+pathObj.imgLorgX),this.xscl*scale*(pathObj.imgY+pathObj.imgLorgY),this.xscl*scale*pathObj.width,this.xscl*scale*pathObj.height),this.ctx.restore(),pathObj.bBoxCmds.forEach(function(drwcmd){var pt,drwOrg
drwcmd.parms.length&&(pt=degs?rotXY(drwcmd.parms[0]):[drwcmd.parms[0][0],drwcmd.parms[0][1]],pt[0]*=scale*savThis.xscl,pt[1]*=-scale*savThis.xscl,drwOrg=savThis.toPixelCoords(xPos,yPos),drwcmd.parmsPx[0]=pt[0]+drwOrg.x,drwcmd.parmsPx[1]=pt[1]+drwOrg.y)}),pathObj.border&&(this.ctx.save(),this.ctx.beginPath(),pathObj.bBoxCmds.forEach(function(drwCmd){savThis.ctx[drwCmd.drawFn].apply(savThis.ctx,drwCmd.parmsPx)}),this.ctx.strokeStyle=pathObj.strokeCol||this.penCol,this.ctx.lineWidth=pathObj.lineWidth||this.penWid,this.ctx.lineCap=pathObj.lineCap||this.lineCap,this.ctx.stroke(),this.ctx.restore()),pathObj.dwgOrg.x=xPos,pathObj.dwgOrg.y=yPos,null!==pathObj.dragNdrop&&(currLr=this.getHostLayer(),currLr!==pathObj.dragNdrop.layer&&pathObj.dragNdrop.layer&&(aidx=pathObj.dragNdrop.layer.dragObjects.indexOf(this),-1!==aidx&&pathObj.dragNdrop.layer.dragObjects.splice(aidx,1)),pathObj.dragNdrop.cgo=this,pathObj.dragNdrop.layer=currLr,-1===pathObj.dragNdrop.layer.dragObjects.indexOf(pathObj)&&pathObj.dragNdrop.layer.dragObjects.push(pathObj))},Cango.prototype.paintPath=function(pathObj,x,y,scl,degrees){function genLinGrad(lgrad,iso){var grad,p1x=lgrad.grad[0],p1y=lgrad.grad[1],p2x=lgrad.grad[2],p2y=lgrad.grad[3],xScale=savThis.xscl,yScale=savThis.yscl
return iso&&(yScale=savThis.yscl>0?savThis.xscl:-savThis.xscl),grad=savThis.ctx.createLinearGradient(xScale*p1x,yScale*p1y,xScale*p2x,yScale*p2y),lgrad.colorStops.forEach(function(colStop){grad.addColorStop(colStop[0],colStop[1])}),grad}function genRadGrad(rgrad,iso){var grad,p1x=rgrad.grad[0],p1y=rgrad.grad[1],r1=rgrad.grad[2],p2x=rgrad.grad[3],p2y=rgrad.grad[4],r2=rgrad.grad[5],xScale=savThis.xscl,yScale=savThis.yscl
return iso&&(yScale=savThis.yscl>0?savThis.xscl:-savThis.xscl),grad=savThis.ctx.createRadialGradient(xScale*p1x,yScale*p1y,xScale*r1,xScale*p2x,yScale*p2y,xScale*r2),rgrad.colorStops.forEach(function(colStop){grad.addColorStop(colStop[0],colStop[1])}),grad}function rotXY(p){return[p[0]*cosA-p[1]*sinA,p[0]*sinA+p[1]*cosA]}var A,sinA,cosA,j,col,gradFill,currLr,aidx,savThis=this,xPos=x||0,yPos=y||0,scale=scl||1,degs=degrees||0,xPx=this.vpOrgX+this.xoffset+xPos*this.xscl,yPx=this.vpOrgY+this.yoffset+yPos*this.yscl,xsl=this.xscl,ysl=this.yscl
pathObj.iso&&(ysl=this.yscl>0?this.xscl:-this.xscl),degs&&(A=this.yscl>0?-degs*Math.PI/180:degs*Math.PI/180,sinA=Math.sin(A),cosA=Math.cos(A)),this.ctx.save(),this.dropShadow(pathObj,scale),this.ctx.translate(xPx,yPx),this.ctx.scale(scale,scale),this.ctx.beginPath(),pathObj.drawCmds.forEach(function(drwCmd){drwCmd.parmsPx=[],drwCmd.parms.forEach(function(coord){var pt
pt=degs?rotXY(coord):[coord[0],coord[1]],pt[0]*=xsl,pt[1]*=ysl,drwCmd.parmsPx.push(pt[0],pt[1])}),savThis.ctx[drwCmd.drawFn].apply(savThis.ctx,drwCmd.parmsPx)}),"SHAPE"===pathObj.type&&(col=pathObj.fillCol||this.paintCol,col instanceof LinearGradient?(gradFill=genLinGrad(col,pathObj.iso),this.ctx.fillStyle=gradFill):col instanceof RadialGradient?(gradFill=genRadGrad(col,pathObj.iso),this.ctx.fillStyle=gradFill):this.ctx.fillStyle=col,this.ctx.fill(),this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.shadowBlur=0),("PATH"===pathObj.type||pathObj.border)&&(pathObj.dashed&&(this.ctx.setLineDash(pathObj.dashed),this.ctx.lineDashOffset=pathObj.dashOffset),this.ctx.strokeStyle=pathObj.strokeCol||this.penCol,this.ctx.lineWidth=pathObj.lineWidth||this.penWid,this.ctx.lineCap=pathObj.lineCap||this.lineCap,this.ctx.stroke()),this.ctx.restore(),pathObj.drawCmds.forEach(function(drwCmd){for(j=0;j<drwCmd.parms.length;j++)drwCmd.parmsPx[2*j]=drwCmd.parmsPx[2*j]*scale+xPx,drwCmd.parmsPx[2*j+1]=drwCmd.parmsPx[2*j+1]*scale+yPx}),pathObj.dwgOrg.x=xPos,pathObj.dwgOrg.y=yPos,null!==pathObj.dragNdrop&&(currLr=this.getHostLayer(),currLr!==pathObj.dragNdrop.layer&&pathObj.dragNdrop.layer&&(aidx=pathObj.dragNdrop.layer.dragObjects.indexOf(this),-1!==aidx&&pathObj.dragNdrop.layer.dragObjects.splice(aidx,1)),pathObj.dragNdrop.cgo=this,pathObj.dragNdrop.layer=currLr,-1===pathObj.dragNdrop.layer.dragObjects.indexOf(pathObj)&&pathObj.dragNdrop.layer.dragObjects.push(pathObj))},Cango.prototype.paintText=function(pathObj,x,y,scl,degrees){function rotXY(p){return[p[0]*cosA-p[1]*sinA,p[0]*sinA+p[1]*cosA]}var sinA,cosA,fntWt,fntSz,fntFm,currLr,aidx,savThis=this,A=0,xPos=x||0,yPos=y||0,xScale=scl||1,scale=xScale*pathObj.imgXscale,degs=degrees||0
this.ctx.save(),this.dropShadow(pathObj,scale),this.ctx.translate(this.vpOrgX+this.xoffset+xPos*this.xscl,this.vpOrgY+this.yoffset+yPos*this.yscl),this.ctx.scale(scale,scale),degs+=pathObj.imgDegs,degs&&(A=this.yscl>0?-degs*Math.PI/180:degs*Math.PI/180,sinA=Math.sin(A),cosA=Math.cos(A),this.ctx.rotate(-A)),fntWt=pathObj.fontWeight||this.fontWeight,fntSz=pathObj.fontSize||this.fontSize,fntFm=pathObj.fontFamily||this.fontFamily,this.ctx.font=fntWt+" "+fntSz+"px "+fntFm,this.ctx.fillStyle=pathObj.fillCol||this.paintCol,this.ctx.fillText(pathObj.drawCmds,this.xscl*(pathObj.imgX+pathObj.imgLorgX),this.xscl*(pathObj.imgY+pathObj.imgLorgY)),pathObj.border&&(this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.shadowBlur=0,this.ctx.strokeStyle=pathObj.strokeCol||this.penCol,this.ctx.lineWidth=pathObj.lineWidth||this.penWid,this.ctx.lineCap=pathObj.lineCap||this.lineCap,this.ctx.strokeText(pathObj.drawCmds,this.xscl*(pathObj.imgX+pathObj.imgLorgX),this.xscl*(pathObj.imgY+pathObj.imgLorgY))),this.ctx.restore(),pathObj.bBoxCmds.forEach(function(drwcmd){var pt,drwOrg
drwcmd.parms.length&&(pt=degs?rotXY(drwcmd.parms[0]):[drwcmd.parms[0][0],drwcmd.parms[0][1]],pt[0]*=scale*savThis.xscl,pt[1]*=-scale*savThis.xscl,drwOrg=savThis.toPixelCoords(xPos,yPos),drwcmd.parmsPx[0]=pt[0]+drwOrg.x,drwcmd.parmsPx[1]=pt[1]+drwOrg.y)}),pathObj.dwgOrg.x=xPos,pathObj.dwgOrg.y=yPos,null!==pathObj.dragNdrop&&(currLr=this.getHostLayer(),currLr!==pathObj.dragNdrop.layer&&pathObj.dragNdrop.layer&&(aidx=pathObj.dragNdrop.layer.dragObjects.indexOf(this),-1!==aidx&&pathObj.dragNdrop.layer.dragObjects.splice(aidx,1)),pathObj.dragNdrop.cgo=this,pathObj.dragNdrop.layer=currLr,-1===pathObj.dragNdrop.layer.dragObjects.indexOf(pathObj)&&pathObj.dragNdrop.layer.dragObjects.push(pathObj))},Cango.prototype.drawPath=function(path,x,y,options){var pathObj=new Cobj(path,"PATH",options)
return this.render(pathObj,x,y),pathObj},Cango.prototype.drawShape=function(path,x,y,options){var shapeObj=new Cobj(path,"SHAPE",options)
return this.render(shapeObj,x,y),shapeObj},Cango.prototype.drawText=function(str,x,y,options){var txtObj=new Cobj(str,"TEXT",options)
return this.render(txtObj,x,y),txtObj},Cango.prototype.drawImg=function(imgURL,x,y,options){var imgObj=new Cobj(imgURL,"IMG",options)
return this.render(imgObj,x,y),imgObj},Cango.prototype.clipPath=function(pathObj){var xsl,ysl,savThis=this
"IMG"!==pathObj.type&&"TEXT"!==pathObj.type&&(xsl=this.xscl,ysl=this.yscl,pathObj.iso&&(ysl=this.yscl>0?this.xscl:-this.xscl),this.ctx.save(),this.ctx.beginPath(),pathObj.drawCmds.forEach(function(drwCmd){var px,py,pxlCoords=[]
drwCmd.parms.forEach(function(coord){px=savThis.vpOrgX+savThis.xoffset+xsl*coord[0],py=savThis.vpOrgY+savThis.yoffset+ysl*coord[1],pxlCoords.push(px,py)}),savThis.ctx[drwCmd.drawFn].apply(savThis.ctx,pxlCoords)}),this.ctx.clip())},Cango.prototype.resetClip=function(){this.ctx.restore()},Cango.prototype.createLayer=function(){var ovlHTML,newCvs,unique,ovlId,newL,topCvs,w=this.rawWidth,h=this.rawHeight,nLyrs=this.bkgCanvas.layers.length
return-1!==this.cId.indexOf("_ovl_")?(console.log("canvas layers can't create layers"),""):(unique=this.getUnique(),ovlId=this.cId+"_ovl_"+unique,ovlHTML="<canvas id='"+ovlId+"' style='position:absolute' width='"+w+"' height='"+h+"'></canvas>",topCvs=this.bkgCanvas.layers[nLyrs-1].cElem,topCvs.insertAdjacentHTML("afterend",ovlHTML),newCvs=document.getElementById(ovlId),newCvs.style.backgroundColor="transparent",newCvs.style.left=this.bkgCanvas.offsetLeft+this.bkgCanvas.clientLeft+"px",newCvs.style.top=this.bkgCanvas.offsetTop+this.bkgCanvas.clientTop+"px",newCvs.style.width=this.bkgCanvas.offsetWidth+"px",newCvs.style.height=this.bkgCanvas.offsetHeight+"px",newL=new Layer(ovlId,newCvs),this.bkgCanvas.layers.push(newL),ovlId)},Cango.prototype.deleteLayer=function(ovlyId){var ovlNode,i
for(i=1;i<this.bkgCanvas.layers.length;i++)this.bkgCanvas.layers[i].id===ovlyId&&(ovlNode=this.bkgCanvas.layers[i].cElem,ovlNode&&(ovlNode.alphaOvl&&ovlNode.alphaOvl.parentNode&&ovlNode.alphaOvl.parentNode.removeChild(ovlNode.alphaOvl),ovlNode.parentNode.removeChild(ovlNode)),this.bkgCanvas.layers.splice(i,1))},Cango.prototype.deleteAllLayers=function(){var i,ovlNode
for(i=this.bkgCanvas.layers.length-1;i>0;i--)ovlNode=this.bkgCanvas.layers[i].cElem,ovlNode&&(ovlNode.alphaOvl&&ovlNode.alphaOvl.parentNode&&ovlNode.alphaOvl.parentNode.removeChild(ovlNode.alphaOvl),ovlNode.parentNode.removeChild(ovlNode)),this.bkgCanvas.layers.splice(i,1)},Cango.prototype.dupCtx=function(src_graphCtx){this.vpW=src_graphCtx.vpW,this.vpH=src_graphCtx.vpH,this.vpOrgX=src_graphCtx.vpOrgX,this.vpOrgY=src_graphCtx.vpOrgY,this.xscl=src_graphCtx.xscl,this.yscl=src_graphCtx.yscl,this.xoffset=src_graphCtx.xoffset,this.yoffset=src_graphCtx.yoffset,this.savWC=clone(src_graphCtx.savWC),this.penCol=src_graphCtx.penCol.slice(0),this.penWid=src_graphCtx.penWid,this.lineCap=src_graphCtx.lineCap.slice(0),this.paintCol=src_graphCtx.paintCol.slice(0),this.fontFamily=src_graphCtx.fontFamily.slice(0),this.fontSize=src_graphCtx.fontSize,this.fontWeight=src_graphCtx.fontWeight},Cango.prototype.toImgObj=function(obj){var top,rgt,bot,lft,dx,dy,w,h,buf,gc,i,j,xsc=this.xscl,ysc=obj.iso?-this.xscl:this.yscl,img=new Image,imgObj=new Cobj(img,"IMG")
if("PATH"!==obj.type&&"SHAPE"!==obj.type)return null
for(lft=rgt=obj.drawCmds[0].parms[0][0],bot=top=obj.drawCmds[0].parms[0][1],i=1;i<obj.drawCmds.length;i++)for(j=0;j<obj.drawCmds[i].parms.length;j++)obj.drawCmds[i].parms[j][0]>rgt&&(rgt=obj.drawCmds[i].parms[j][0]),obj.drawCmds[i].parms[j][0]<lft&&(lft=obj.drawCmds[i].parms[j][0]),obj.drawCmds[i].parms[j][1]>top&&(top=obj.drawCmds[i].parms[j][1]),obj.drawCmds[i].parms[j][1]<bot&&(bot=obj.drawCmds[i].parms[j][1])
return dx=lft*xsc-2,dy=this.yscl>0?bot*ysc-2:bot*ysc+2,w=(rgt-lft)*xsc+4,h=-(top-bot)*ysc+4,buf=document.createElement("canvas"),buf.setAttribute("width",w),buf.setAttribute("height",h),gc=new Cango(this.cId),gc.dupCtx(this),gc.cnvs=buf,gc.cId="_sprite_",gc.ctx=gc.cnvs.getContext("2d"),gc.rawWidth=w,gc.rawHeight=h,gc.vpW=gc.rawWidth,gc.vpH=gc.rawHeight,gc.vpOrgX=0,gc.vpOrgY=this.yscl>0?0:gc.rawHeight,gc.xoffset=-dx,gc.yoffset=-dy,this.paintPath.call(gc,obj),imgObj.imgXscale=1/this.xscl,imgObj.drawCmds.src=gc.cnvs.toDataURL(),imgObj},Cango}()